<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ - Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ù‡ÙˆÙ„Ø©">
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: sans-serif, 'Courier New', Courier, monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .form-container {
            background: rgb(251, 239, 225);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(83, 39, 1, 0.3);
            max-width: 500px;
            width: 100%;
        }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        gmp-place-autocomplete {
            width: 100%;
            background: white !important;
            color: rgb(0, 0, 0) !important;
            border: 2px solid #ddd !important;
            border-radius: 6px !important;
        }
        gmp-place-autocomplete::part(input) {
            background: white !important;
            color: rgb(0, 0, 0) !important;
            border: none !important;
            padding: 0 !important;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff9500;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        input.input-error, textarea.input-error {
            border-color: #e53935;
        }
        .error-msg {
            color: #e53935;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover:not(:disabled) {
            background: #764ba2;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .whatsapp-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            margin-top: 12px;
        }
        .whatsapp-btn .emoji {
            width: 20px;
            height: 20px;
            flex: 0 0 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .whatsapp-btn:hover {
            background: #1ebe5a;
            box-shadow: none;
        }
        .loc-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            cursor: pointer;
        }
        .loc-btn:hover { background: #3a78c6; }
        .calc-btn {
            background: #4A90E2;
            margin-bottom: 8px;
            display: block;
            width: 100%;
            padding: 10px 12px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-top: 16px;
            cursor: pointer;
        }
        .success-msg {
            background: #c8e6c9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }
        .lang-switcher-container {
            position: absolute;
            top: 15px;
            right: 15px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .lang-switcher-container.expanded {
            display: block;
        }
        .lang-switcher-btn {
            width: auto;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: bold;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
        }
        .lang-switcher-btn:hover {
            background: #764ba2;
        }
        .lang-switcher-menu {
            position: absolute;
            top: 45px;
            right: 0;
            list-style: none;
            background: white;
            border: 2px solid #f39c12;
            border-radius: 4px;
            overflow: hidden;
            display: none;
            z-index: 1000;
            min-width: 60px;
        }
        .lang-switcher-container.expanded .lang-switcher-menu {
            display: block;
        }
        .lang-switcher-menu li {
            margin: 0;
            padding: 0;
        }
        .lang-switcher-menu button {
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            background: white;
            color: #333;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
        }
        .lang-switcher-menu button:hover {
            background: #f39c12;
            color: white;
        }
        .form-container {
            position: relative;
        }
        @media(max-width: 480px) {
            .form-container { padding: 20px; }
            h1 { font-size: 20px; }
            .lang-switcher-container {
                top: 10px;
                right: 10px;
            }
            .lang-switcher-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
<div class="form-container">
    <div class="lang-switcher-container">
        <button id="langToggle" class="lang-switcher-btn">AR</button>
        <ul class="lang-switcher-menu">
            <li><button data-lang="ar" class="lang-option-btn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (AR)</button></li>
            <li><button data-lang="fr" class="lang-option-btn">FranÃ§ais (FR)</button></li>
            <li><button data-lang="en" class="lang-option-btn">English (EN)</button></li>
        </ul>
    </div>
    <h1>ğŸ“‹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨</h1>
    <form class="order-form">
        <div class="form-group">
            <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
            <input id="name" type="text" name="name" required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
        </div>

        <div class="form-group">
            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
            <input id="phone" type="tel" name="phone" placeholder="06XXXXXXXX" required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­</div>
        </div>
        <div class="form-group">
            <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
            <input id="address" type="text" name="address" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹..." required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­</div>
        </div>

        <div class="form-group">
            <label for="pickupAutocomplete">ğŸ“ Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø£Ùˆ Ø§Ù„Ø¥Ø³ØªÙ„Ø§Ù… </label>
            <gmp-place-autocomplete
                id="pickupAutocomplete"
                country="ma"
                placeholder=" Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡ØŒ Ø§Ù„Ù…Ù‚Ù‡Ù‰ØŒ Ø§Ù„Ù…Ø·Ø¹Ù…...">
            </gmp-place-autocomplete>
        </div>

        <div class="form-group">
            <label for="location">ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ :Google Maps</label>
            <input id="location" name="location" type="text" style="text-align: right;" dir="ltr" placeholder="35.73401, -5.85322">
            <div class="error-msg" id="locStatus" style="display:block; color:#666; font-size:13px; margin-top:5px;"></div>
            <button type="button" id="locBtn" class="loc-btn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>

        <div class="form-group">
            <label for="note">Ù…Ù„Ø§Ø­Ø¸Ø© *</label>
            <textarea id="note" name="note" rows="4" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŒ ÙˆØ£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
            Ù…Ø«Ø§Ù„: Ø®Ø°Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ°Ø§ ÙˆÙƒØ°Ø§ Ù…Ù† ÙƒØ§ÙÙŠÙ‡ Ø·Ù†Ø¬Ø© ÙˆØ³Ù„Ù…ÙˆÙ‡ ÙØ§Ù„Ø³Ø§Ø¹Ø© ÙƒØ°Ø§ ÙˆÙƒØ°Ø§
            "></textarea>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨</div>
        </div>

        <div class="form-group">
            <label for="datetime">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„ *</label>
            <input id="datetime"
                type="datetime-local"
                name="datetime"
                required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        </div>

        <div class="form-group", 
        style="
            font-size:16px;
            margin-bottom:10px;
            padding:10px;
            background:#f9f9f9;
            border:1px solid #ddd;
            border-radius:6px;
            text-align:center;
            direction: rtl;
            ">
            <label for="price" style="font-weight:bold; margin-bottom:10px; display:block;"> Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØµÙŠÙ„</label>
            <div>ğŸ›µ Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù†Ø·Ù„Ø§Ù‚: <span id="startDistanceText">--</span></div>
            <div>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="distanceText">--</span></div>
            <div>ğŸ’° Ø§Ù„Ø«Ù…Ù†: <strong><span id="priceText">--</span> MAD</strong></div>
            <span style="font-size:12px; color:#666;">(Ø§Ù„Ø«Ù…Ù† Ù…Ø­Ø³ÙˆØ¨ Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 20 Ø¯Ø±Ù‡Ù…)</span>
            <button type="button" id="calculateFinalPrice" class="calc-btn" onclick="calculatePrice()">Ø­Ø³Ø§Ø¨ Ø«Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</button>
            <label for="alert" style="font-size:12px; color:#666; display:block;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³Ø§ÙØ© ØªØªØ¶Ù…Ù† Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù†Ø·Ù„Ø§Ù‚</label>
        </div>

        <button type="submit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
        <a id="whatsappBtn" class="whatsapp-btn" href="https://wa.me/212663165488" target="_blank" rel="noopener" aria-label="Ø§ØªØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨" title="ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
            <span class="emoji" aria-hidden="true">ğŸ’¬</span>
            <span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
        </a>
    </form>
      <!-- /* ØµÙØ­Ø© Ø§Ù„Ø´ÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */ -->
    <div id="thankYouPage" style="display:none; text-align:center; padding:40px;">
        <h2 style="color:#0a7d3b;">Ø´ÙƒØ±Ø§Ù‹! âœ…</h2>
        <p style="font-size:18px; margin-top:15px;">
            ØªÙ…Ù‘ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­<br>
            Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯.
        </p>
    </div>
</div>
<script>
    /* Code for Form price handling based on distance and zone */
    const DRIVER_START = {lat: 35.73403806303631, lng: -5.853216127230949}; // Ø³ÙˆÙ‚ Ø§Ù„Ù‚Ø±Ø¨ØŒ Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø³Ù†ÙŠØŒ Ø·Ù†Ø¬Ø©
    let pickupLocation = null;
    let clientLocation = null;
    let lockedPrice = null;

    const form = document.querySelector('.order-form');
    /* Check if order was already sent in this session */
    window.addEventListener('pageshow', () => {
        if (sessionStorage.getItem('orderSent_')) {
        form.style.display = 'none';
        document.getElementById('thankYouPage').style.display = 'block';
        }
    });

    // Geolocation: improved handler that waits for permission, prompts to enable GPS, and retries once
    const locInput = document.getElementById('location');
    const locBtn = document.getElementById('locBtn');
    const locStatus = document.getElementById('locStatus');

    const dt = new Date().toISOString().slice(0,16); // YYYY-MM-DDTHH:MM
    document.getElementById('datetime').value = dt;

  async function attemptGetLocation() {
    // 1. Initial Checks
    if (!navigator.geolocation) {
      updateStatus('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
      return;
    }

    // 2. Variable Scoping & UI Setup
    // We define these outside the helper so they are accessible everywhere
    const originalBtnText = locBtn.textContent; 
  
    if (locStatus) {
      locStatus.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
      locBtn.disabled = true;
      updateStatus('');
    }

    // Helper to reset UI state
    function resetUI() {
      locBtn.disabled = false;
      locBtn.textContent = originalBtnText;
    }

    // Helper to update status text
    function updateStatus(msg) {
      if (locStatus) locStatus.textContent = msg;
    }

    const options = {
      enableHighAccuracy: true, 
      timeout: 20000,           
      maximumAge: 0 // Changed to 0 to ensure fresh data if the previous attempt failed
    };

    console.log('Secure context:', window.isSecureContext);
    console.log('Triggered by click:', document.activeElement === locBtn);

    // 3. The Request
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        
        locInput.value = `${lat},${lng}`;
        clientLocation = { lat: parseFloat(lat), lng: parseFloat(lng) };
        updateStatus('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
        resetUI(); // Use the helper to stay consistent
      },
      (err) => {
        console.error("Geolocation Error:", err);
        handleLocationError(err);
        resetUI(); // Ensure button is re-enabled on error
      },
      options
    );

    function handleLocationError(err) {
      let msg = "";
      switch (err.code) {
        case 1: msg = "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ."; break;
        case 2: msg = "Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¶Ø¹ÙŠÙØ© Ø£Ùˆ Ø§Ù„Ù€ GPS Ù…ØºÙ„Ù‚."; break;
        case 3: msg = "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ù…ÙƒØ§Ù† Ù…ÙØªÙˆØ­."; break;
        default: msg = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.";
      }
      console.log(err.code, err.message);
      updateStatus(msg);
    }
  }

    if (locBtn && locInput) {
        locBtn.addEventListener('click', () => attemptGetLocation());
    }

    /* Google Maps Place Autocomplete for Pickup Location and price calculation*/
    function initPickupAutocomplete() {
        console.log("Google Maps loaded â†’ initPickupAutocomplete");
        customElements.whenDefined("gmp-place-autocomplete").then(() => {
            console.log("gmp-place-autocomplete ready");

            const el = document.getElementById("pickupAutocomplete");
            if (!el) {
                console.error("Pickup autocomplete element not found");
                return;
            }

            //Ø¯Ø§Ø¦Ø±Ø© Ø­ÙˆÙ„ Ù…Ø±ÙƒØ² Ø·Ù†Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
            el.locationBias = {
                center: { lat: 35.7595, lng: -5.83395 },
                radius: 8000 // 8 ÙƒÙ…
            };
        });
    }

    function calculateFinalPrice(km) {
        const price = km * 3; // 3 Ø¯Ø±Ø§Ù‡Ù… Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        return price < 20 ? 20 : Math.ceil(price);
    }

    function calculatePrice() {
        try {
            // Fallbacks in case locations are not set via autocomplete or geolocation
            const pickupEl = document.getElementById("pickupAutocomplete");
            pickupLocation = pickupEl?.value || pickupEl?.textContent || null;
            console.log("Pickup Location after fallback:", pickupLocation);
            
            const locationInput = document.getElementById("location");
            const locationStr = locationInput?.value?.trim();
            if (locationStr) {
                const [lat, lng] = locationStr.split(',').map(s => parseFloat(s.trim()));
                if (!isNaN(lat) && !isNaN(lng)) {
                    clientLocation = { lat, lng };
                }
            }
            console.log("Client Location after fallback:", clientLocation);
        

            if (!pickupLocation || !clientLocation) {
                alert("Please select pickup and detect your location");
                return;
            }else{
                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix(
                    {
                        origins: [DRIVER_START, pickupLocation],
                        destinations: [pickupLocation, clientLocation],
                        travelMode: google.maps.TravelMode.DRIVING
                    },
                    (response, status) => {
                        if (status !== "OK") {
                            alert("Distance calculation failed");
                            return;
                        }

                        const d1 = response.rows[0].elements[0].distance.value; // meters
                        const d2 = response.rows[1].elements[1].distance.value;

                        const totalKm = (d1 + d2) / 1000;
                        const price = calculateFinalPrice(totalKm);

                        lockedPrice = price;

                        document.getElementById("startDistanceText").innerText =(d1/1000).toFixed(1) + " km";
                        document.getElementById("distanceText").innerText =totalKm.toFixed(1) + " km";
                        document.getElementById("priceText").innerText = price;
                    }
                );
                }
        } catch (error) {
            console.error("Error calculating price:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø«Ù…Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
        }
    }

    // Form submission handling

    let isSubmitting = false;
    const AppScriptURL = 'https://script.google.com/macros/s/AKfycbxtcYMt18dXPalLYTYUOfSl9JwWygjQTJImSiyF991MrFebQF40TC4_N0LRehxdSRzcaQ/exec'; // ØºÙŠÙ‘Ø±Ù‡Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø³ÙƒØ±ÙŠØ¨Øª Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡


    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (isSubmitting) return;
        isSubmitting = true;

        const data = {
            date: form.datetime.value.trim(),
            name: form.name.value.trim(),
            phone: form.phone.value.trim(),
            address: form.address.value.trim(),
            note: form.note.value.trim()
        };
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

        // Build form-encoded data from the actual form (ensures textarea and all fields are included)
        const formParams = new URLSearchParams();
        for (const [k, v] of new FormData(form)) {
            const value = (typeof v === 'string') ? v.trim() : v;
            formParams.append(k, value);
        }
        // Debug: show which fields will be sent
        console.log('Submitting fields:', Array.from(formParams.entries()));

        fetch(AppScriptURL, {
            method: 'POST',
            body: formParams // browser will use application/x-www-form-urlencoded
        })
        .then(response => {
            if (response.ok) {
                form.reset();
                sessionStorage.setItem('orderSent_', 'true');
                form.style.display = 'none';
                document.getElementById('thankYouPage').style.display = 'block';
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
        })
        .finally(() => {
            // restore submit state
            isSubmitting = false;
            submitButton.disabled = false;
            submitButton.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        });
    });

    // Language Translation System
    const translations = {
        ar: {
            title: "ğŸ“‹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨",
            fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *",
            fullNameError: "Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
            phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *",
            phoneError: "Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­",
            phonePlaceholder: "06XXXXXXXX",
            address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *",
            addressError: "Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­",
            addressPlaceholder: "Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹...",
            pickupLocation: "ğŸ“ Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø£Ùˆ Ø§Ù„Ø¥Ø³ØªÙ„Ø§Ù…",
            pickupPlaceholder: " Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡ØŒ Ø§Ù„Ù…Ù‚Ù‡Ù‰ØŒ Ø§Ù„Ù…Ø·Ø¹Ù…...",
            userLocation: "ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ :Google Maps",
            locationBtn: "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹",
            note: "Ù…Ù„Ø§Ø­Ø¸Ø© *",
            noteError: "Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨",
            notePlaceholder: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŒ ÙˆØ£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)\n            Ù…Ø«Ø§Ù„: Ø®Ø°Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ°Ø§ ÙˆÙƒØ°Ø§ Ù…Ù† ÙƒØ§ÙÙŠÙ‡ Ø·Ù†Ø¬Ø© ÙˆØ³Ù„Ù…ÙˆÙ‡ ÙØ§Ù„Ø³Ø§Ø¹Ø© ÙƒØ°Ø§ ÙˆÙƒØ°Ø§",
            datetime: "ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„ *",
            datetimeError: "Ø§Ù„Ù…Ø±Ø¬Ùˆ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„",
            deliverySummary: "ğŸ›µ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙˆØµÙŠÙ„",
            startDistance: "ğŸ Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù†Ø·Ù„Ø§Ù‚:",
            distance: "ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©:",
            price: "ğŸ’° Ø§Ù„Ø«Ù…Ù†:",
            minPrice: "(Ø§Ù„Ø«Ù…Ù† Ù…Ø­Ø³ÙˆØ¨ Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 20 Ø¯Ø±Ù‡Ù…)",
            calculateBtn: "Ø­Ø³Ø§Ø¨ Ø«Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„",
            distanceNote: "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³Ø§ÙØ© ØªØªØ¶Ù…Ù† Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù†Ø·Ù„Ø§Ù‚",
            submitBtn: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨",
            whatsappText: "ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨",
            thankYouTitle: "Ø´ÙƒØ±Ø§Ù‹! âœ…",
            thankYouMessage: "ØªÙ…Ù‘ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­<br>Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯."
        },
        fr: {
            title: "ğŸ“‹ Formulaire de Commande",
            fullName: "Nom Complet *",
            fullNameError: "Veuillez entrer votre nom complet",
            phone: "NumÃ©ro de TÃ©lÃ©phone *",
            phoneError: "Veuillez entrer un numÃ©ro de tÃ©lÃ©phone valide",
            phonePlaceholder: "06XXXXXXXX",
            address: "Adresse *",
            addressError: "Veuillez entrer une adresse valide",
            addressPlaceholder: "Quartier, rue...",
            pickupLocation: "ğŸ“ SÃ©lectionnez un point de livraison ou de retrait",
            pickupPlaceholder: "Destinataire, cafÃ©, restaurant...",
            userLocation: "ğŸ“ DÃ©finir votre localisation : Google Maps",
            locationBtn: "Localiser",
            note: "Remarque *",
            noteError: "Veuillez entrer les informations de livraison",
            notePlaceholder: "DÃ©tails de la livraison (lieu de retrait, dÃ©tails de la commande, remarques supplÃ©mentaires)\nExemple: RÃ©cupÃ©rez la commande X et Y du cafÃ© Tanger et livrez-la Ã  telle heure",
            datetime: "Date et Heure de Livraison *",
            datetimeError: "Veuillez sÃ©lectionner une date et une heure de livraison",
            deliverySummary: "ğŸ›µ RÃ©sumÃ© de la Livraison",
            startDistance: "ğŸ Distance de dÃ©part:",
            distance: "ğŸ“ Distance:",
            price: "ğŸ’° Prix:",
            minPrice: "(Prix calculÃ© avec un minimum de 20 MAD)",
            calculateBtn: "Calculer le prix de livraison",
            distanceNote: "Remarque: La distance comprend la distance de dÃ©part",
            submitBtn: "Confirmer la Commande",
            whatsappText: "Contacter via WhatsApp",
            thankYouTitle: "Merci ! âœ…",
            thankYouMessage: "Votre commande a Ã©tÃ© reÃ§ue avec succÃ¨s<br>Nous vous contactera bientÃ´t pour confirmation."
        },
        en: {
            title: "ğŸ“‹ Order Form",
            fullName: "Full Name *",
            fullNameError: "Please enter your full name",
            phone: "Phone Number *",
            phoneError: "Please enter a valid phone number",
            phonePlaceholder: "06XXXXXXXX",
            address: "Address *",
            addressError: "Please enter a valid address",
            addressPlaceholder: "District, Street...",
            pickupLocation: "ğŸ“ Select a delivery or pickup point",
            pickupPlaceholder: "Recipient, cafÃ©, restaurant...",
            userLocation: "ğŸ“ Set Your Location: Google Maps",
            locationBtn: "Locate",
            note: "Note *",
            noteError: "Please enter delivery information",
            notePlaceholder: "Delivery details (pickup location, order details, additional notes)\nExample: Pick up order X and Y from Tanger cafÃ© and deliver at such time",
            datetime: "Delivery Date and Time *",
            datetimeError: "Please select a delivery date and time",
            deliverySummary: "ğŸ›µ Delivery Summary",
            startDistance: "ğŸ Start Distance:",
            distance: "ğŸ“ Distance:",
            price: "ğŸ’° Price:",
            minPrice: "(Price calculated with a minimum of 20 MAD)",
            calculateBtn: "Calculate Delivery Price",
            distanceNote: "Note: Distance includes the start distance",
            submitBtn: "Confirm Order",
            whatsappText: "Contact via WhatsApp",
            thankYouTitle: "Thank You! âœ…",
            thankYouMessage: "Your order has been received successfully<br>We will contact you soon for confirmation."
        }
    };

    let currentLang = 'ar';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('selectedLang', lang);
        
        // Update HTML element lang and dir
        const html = document.documentElement;
        html.lang = lang;
        html.dir = lang === 'ar' ? 'rtl' : 'ltr';
        
        // Update form container direction
        const formContainer = document.querySelector('.form-container');
        formContainer.style.direction = lang === 'ar' ? 'rtl' : 'ltr';
        
        // Update toggle button text
        document.getElementById('langToggle').textContent = lang.toUpperCase();
        
        // Close the dropdown
        document.querySelector('.lang-switcher-container').classList.remove('expanded');
        
        // Update all translations
        const t = translations[lang];
        
        // Title
        document.querySelector('h1').textContent = t.title;
        
        // Update all input labels by scanning the DOM
        const allLabels = document.querySelectorAll('label');
        allLabels.forEach(label => {
            const forAttr = label.getAttribute('for');
            if (forAttr === 'name') label.textContent = t.fullName;
            if (forAttr === 'phone') label.textContent = t.phone;
            if (forAttr === 'address') label.textContent = t.address;
            if (forAttr === 'pickupAutocomplete') label.textContent = t.pickupLocation;
            if (forAttr === 'location') label.textContent = t.userLocation;
            if (forAttr === 'note') label.textContent = t.note;
            if (forAttr === 'datetime') label.textContent = t.datetime;
            if (forAttr === 'price') label.textContent = t.deliverySummary;
            if (forAttr === 'alert') label.textContent = t.distanceNote;
        });
        
        // Update placeholders
        document.getElementById('phone').placeholder = t.phonePlaceholder;
        document.getElementById('address').placeholder = t.addressPlaceholder;
        document.getElementById('note').placeholder = t.notePlaceholder;
        
        const pickupAuto = document.getElementById('pickupAutocomplete');
        if (pickupAuto) pickupAuto.setAttribute('placeholder', t.pickupPlaceholder);
        
        // Update error messages
        const errorMessages = document.querySelectorAll('.error-msg');
        errorMessages.forEach(msg => {
            if (msg.textContent.includes('Ø§Ù„Ø§Ø³Ù…') || msg.textContent.includes('name') || msg.textContent.includes('nom')) {
                msg.textContent = t.fullNameError;
            } else if (msg.textContent.includes('Ù‡Ø§ØªÙ') || msg.textContent.includes('phone') || msg.textContent.includes('tÃ©lÃ©phone')) {
                msg.textContent = t.phoneError;
            } else if (msg.textContent.includes('Ø¹Ù†ÙˆØ§Ù†') || msg.textContent.includes('address') || msg.textContent.includes('adresse')) {
                msg.textContent = t.addressError;
            } else if (msg.textContent.includes('Ø·Ù„Ø¨') || msg.textContent.includes('livraison') || msg.textContent.includes('delivery')) {
                msg.textContent = t.noteError;
            } else if (msg.textContent.includes('ØªØ§Ø±ÙŠØ®') || msg.textContent.includes('date') || msg.textContent.includes('date')) {
                msg.textContent = t.datetimeError;
            }
        });
        
        // Update buttons
        document.getElementById('locBtn').textContent = t.locationBtn;
        document.getElementById('calculateFinalPrice').textContent = t.calculateBtn;
        
        // Update the summary section divs with proper text
        const priceSpan = document.getElementById('priceText');
        if (priceSpan) {
            const summarySection = priceSpan.closest('.form-group');
            if (summarySection) {
                const summaryDivs = summarySection.querySelectorAll('div');
                
                summaryDivs.forEach(div => {
                    // Update start distance
                    if (div.querySelector('#startDistanceText')) {
                        const span = div.querySelector('#startDistanceText');
                        const text = span.textContent;
                        div.textContent = '';
                        div.innerHTML = `${t.startDistance} <span id="startDistanceText">${text}</span>`;
                    }
                    // Update distance
                    else if (div.querySelector('#distanceText') && !div.querySelector('#startDistanceText')) {
                        const span = div.querySelector('#distanceText');
                        const text = span.textContent;
                        div.textContent = '';
                        div.innerHTML = `${t.distance} <span id="distanceText">${text}</span>`;
                    }
                    // Update price
                    else if (div.querySelector('#priceText')) {
                        const span = div.querySelector('#priceText');
                        const text = span.textContent;
                        div.textContent = '';
                        div.innerHTML = `${t.price} <strong><span id="priceText">${text}</span> MAD</strong>`;
                    }
                });
                
                // Update min price note - find the span with inline style
                const minPriceSpans = summarySection.querySelectorAll('span');
                minPriceSpans.forEach(span => {
                    if (span.style.fontSize === '12px' && span.id !== 'startDistanceText' && span.id !== 'distanceText' && span.id !== 'priceText') {
                        span.textContent = t.minPrice;
                    }
                });
            }
        }
        
        // Submit button
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.textContent = t.submitBtn;
        
        // WhatsApp button
        const whatsappSpan = document.querySelector('.whatsapp-btn span:last-child');
        if (whatsappSpan) whatsappSpan.textContent = t.whatsappText;
        
        // Thank you page
        const thankYouPage = document.getElementById('thankYouPage');
        if (thankYouPage) {
            const h2 = thankYouPage.querySelector('h2');
            const p = thankYouPage.querySelector('p');
            if (h2) h2.textContent = t.thankYouTitle;
            if (p) p.innerHTML = t.thankYouMessage;
        }
    }

    // Language switcher dropdown functionality
    const langToggle = document.getElementById('langToggle');
    const langContainer = document.querySelector('.lang-switcher-container');
    const langOptions = document.querySelectorAll('.lang-option-btn');
    
    langToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        langContainer.classList.toggle('expanded');
    });
    
    langOptions.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const lang = btn.getAttribute('data-lang');
            setLanguage(lang);
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
        langContainer.classList.remove('expanded');
    });

    // Load saved language or default to Arabic
    const savedLang = localStorage.getItem('selectedLang') || 'ar';
    setLanguage(savedLang);





</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5m12bZjgzdYMlf0no4CM049R0F9SrbKw&libraries=places,maps&callback=initPickupAutocomplete&v=beta&loading=async"
  async
  defer>
</script>
</body>
</html>