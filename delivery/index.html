<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ - Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ù‡ÙˆÙ„Ø©">
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: sans-serif, 'Courier New', Courier, monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .form-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
        }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        input.input-error, textarea.input-error {
            border-color: #e53935;
        }
        .error-msg {
            color: #e53935;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover:not(:disabled) {
            background: #764ba2;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .whatsapp-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            margin-top: 12px;
        }
        .whatsapp-btn .emoji {
            width: 20px;
            height: 20px;
            flex: 0 0 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .whatsapp-btn:hover {
            background: #1ebe5a;
            box-shadow: none;
        }
        .loc-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-top: 8px;
            cursor: pointer;
        }
        .loc-btn:hover { background: #3a78c6; }
        .success-msg {
            background: #c8e6c9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
            text-align: center;
        }
        @media(max-width: 480px) {
            .form-container { padding: 20px; }
            h1 { font-size: 20px; }
        }
    </style>
</head>
<body>
<div class="form-container">
    <h1>ğŸ“‹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨</h1>
    <form class="order-form">
        <div class="form-group">
            <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
            <input id="name" type="text" name="name" required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
        </div>

        <div class="form-group">
            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
            <input id="phone" type="tel" name="phone" placeholder="06XXXXXXXX" required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­</div>
        </div>

        <div class="form-group">
            <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
            <input id="address" type="text" name="address" placeholder="Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹..." required>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­</div>
        </div>

        <div class="form-group">
            <label for="location">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="location" name="location" type="text" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶, Ø®Ø· Ø§Ù„Ø·ÙˆÙ„" readonly>
            <div class="error-msg" id="locStatus" style="display:block; color:#666; font-size:13px; margin-top:5px;"></div>
            <button type="button" id="locBtn" class="loc-btn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        </div>

        <div class="form-group">
            <label for="note">Ù…Ù„Ø§Ø­Ø¸Ø© *</label>
            <textarea id="note" name="note" rows="4" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŒ ÙˆØ£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
Ù…Ø«Ø§Ù„: Ø®Ø°Ùˆ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ°Ø§ ÙˆÙƒØ°Ø§ Ù…Ù† ÙƒØ§ÙÙŠÙ‡ Ø·Ù†Ø¬Ø© ÙˆØ³Ù„Ù…ÙˆÙ‡ ÙØ§Ù„Ø³Ø§Ø¹Ø© ÙƒØ°Ø§ ÙˆÙƒØ°Ø§
"></textarea>
            <div class="error-msg">Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨</div>
        </div>

        <button type="submit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
        <a id="whatsappBtn" class="whatsapp-btn" href="https://wa.me/212663165488" target="_blank" rel="noopener" aria-label="Ø§ØªØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨" title="ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
            <span class="emoji" aria-hidden="true">ğŸ’¬</span>
            <span>ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</span>
        </a>
    </form>
      <!-- /* ØµÙØ­Ø© Ø§Ù„Ø´ÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */ -->
    <div id="thankYouPage" style="display:none; text-align:center; padding:40px;">
        <h2 style="color:#0a7d3b;">Ø´ÙƒØ±Ø§Ù‹! âœ…</h2>
        <p style="font-size:18px; margin-top:15px;">
            ØªÙ…Ù‘ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­<br>
            Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù„ØªØ£ÙƒÙŠØ¯.
        </p>
    </div>
</div>


<script>
const form = document.querySelector('.order-form');
  /* Check if order was already sent in this session */
  window.addEventListener('pageshow', () => {
    if (sessionStorage.getItem('orderSent_')) {
      form.style.display = 'none';
      document.getElementById('thankYouPage').style.display = 'block';
    }
  });

  // Geolocation: improved handler that waits for permission, prompts to enable GPS, and retries once
  const locInput = document.getElementById('location');
  const locBtn = document.getElementById('locBtn');
  const locStatus = document.getElementById('locStatus');

  async function attemptGetLocation(retriesLeft = 1) {
  // 1. Initial Checks & UI Setup
  if (!navigator.geolocation) {
    updateStatus('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
    return;
  }

  const originalBtnText = locBtn.textContent;
  locBtn.disabled = true;
  locBtn.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
  updateStatus('');

  // Helper to reset UI state
  function resetUI() {
    locBtn.disabled = false;
    locBtn.textContent = originalBtnText;
  }

  // Helper to update status text
  function updateStatus(msg) {
    if (locStatus) locStatus.textContent = msg;
  }

  // 2. Permission Pre-check
  if (navigator.permissions && navigator.permissions.query) {
    try {
      const permission = await navigator.permissions.query({ name: 'geolocation' });
      if (permission.state === 'denied') {
        updateStatus('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.');
        resetUI();
        return;
      }
    } catch (e) { /* Ignore query errors and proceed to request */ }
  }

  // 3. The Actual Request
  try {
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      });
    });

    // Success
    const { latitude, longitude } = pos.coords;
    locInput.value = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
    updateStatus('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
    resetUI();

  } catch (err) {
    // 4. Error & Retry Logic
    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
    let shouldRetry = false;

    switch (err.code) {
      case 1: // PERMISSION_DENIED
        errorMessage = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.';
        break;
      case 2: // POSITION_UNAVAILABLE
      case 3: // TIMEOUT
        errorMessage = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø±Ø¨Ù…Ø§ GPS Ù…ØºÙ„Ù‚).';
        shouldRetry = true;
        break;
    }

    if (shouldRetry && retriesLeft > 0) {
      const userWantsRetry = confirm(`${errorMessage} Ù‡Ù„ Ù‚Ù…Øª Ø¨ØªØ´ØºÙŠÙ„ GPSØŸ Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
      if (userWantsRetry) {
        return attemptGetLocation(retriesLeft - 1);
      }
    }

    updateStatus(errorMessage);
    resetUI();
  }
}

  if (locBtn && locInput) {
    locBtn.addEventListener('click', () => attemptGetLocation(1));
  }

// Form submission handling
let isSubmitting = false;
const AppScriptURL = 'https://script.google.com/macros/s/AKfycbxtcYMt18dXPalLYTYUOfSl9JwWygjQTJImSiyF991MrFebQF40TC4_N0LRehxdSRzcaQ/exec'; // ØºÙŠÙ‘Ø±Ù‡Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø³ÙƒØ±ÙŠØ¨Øª Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡

form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (isSubmitting) return;
    isSubmitting = true;

    const data = {
        name: form.name.value.trim(),
        phone: form.phone.value.trim(),
        address: form.address.value.trim(),
        note: form.note.value.trim()
    };
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

    // Build form-encoded data from the actual form (ensures textarea and all fields are included)
    const formParams = new URLSearchParams();
    for (const [k, v] of new FormData(form)) {
        const value = (typeof v === 'string') ? v.trim() : v;
        formParams.append(k, value);
    }
    // Debug: show which fields will be sent
    console.log('Submitting fields:', Array.from(formParams.entries()));

    fetch(AppScriptURL, {
        method: 'POST',
        body: formParams // browser will use application/x-www-form-urlencoded
    })
    .then(response => {
        if (response.ok) {
            form.reset();
            sessionStorage.setItem('orderSent_', 'true');
            form.style.display = 'none';
            document.getElementById('thankYouPage').style.display = 'block';
        } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
    })
    .finally(() => {
        // restore submit state
        isSubmitting = false;
        submitButton.disabled = false;
        submitButton.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
    });
});
</script>
</body>
</html>